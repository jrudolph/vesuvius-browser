@import net.virtualvoid.vesuvius._

@(info: ImageInfo)

<h2>Scroll @info.realScroll / @info.segmentId</h2>

<div>Selected layers: @{(20 to 50 by 2).mkString(", ")}</div>
<div><a href="#keyboard_shortcuts">Keyboard shortcuts</a></div>
<div>Note: If page stays blank for a while, layer still needs to be prepared in the background. Stay tuned, or reload after a while.</div>
<p/>
<div id="openseadragon1" style="width: 100%; height: 85%;"></div>
<script src="/openseadragon/openseadragon.min.js"></script>
<script src="/js/jquery-3.7.1.min.js.js"></script>
<script type="text/javascript">

    var origHash = window.location.hash.substring(1);
    var layers = [@for(l <- ((20 to 50 by 2))) { "@l", }];
    @*//, opacity: @{if (l == 32) 1 else 0}, preload: @{if (l == 31 || l == 34) 1 else 0}*@
var viewer = OpenSeadragon({
    id: "openseadragon1",
    prefixUrl: "/openseadragon/images/",
    tileSources: [@for(l <- ((20 to 50 by 2))) { { tileSource: "@l/dzi", opacity: 0, preload: 0, layer: "@l" }, }],
    initialPage: 6,
    showNavigator: true,
    showRotationControl: true,
    //sequenceMode: true,
    preserveViewport: true,
    preload: true,
    debugMode: false,
});

index = 7;

function sibling(index, shownIndex) {
    if (index >= viewer.world.getItemCount()) index = viewer.world.getItemCount() - 1;
    if (index < 0) index = 0;

    if (index == shownIndex) return;
    var tiledImage = viewer.world.getItemAt(index);
    tiledImage.setOpacity(0)
    tiledImage.setPreload(true);
}

function disable_sibling(index) {
    if (index >= viewer.world.getItemCount()) index = viewer.world.getItemCount() - 1;
    if (index < 0) index = 0;

    var tiledImage = viewer.world.getItemAt(index);
    tiledImage.setPreload(false);
}

function show(nextIndex) {
  disable_sibling(index - 1);
  disable_sibling(index + 1);

  var oldTiledImage = viewer.world.getItemAt(index);
  var oldIndex = index;
  index = nextIndex;
  if (index >= viewer.world.getItemCount()) index = viewer.world.getItemCount() - 1;
  if (index < 0) index = 0;
  //console.log(oldIndex, index);
  var newTiledImage = viewer.world.getItemAt(index);
  oldTiledImage.setOpacity(0);
  oldTiledImage.setPreload(false);
  newTiledImage.setOpacity(1);
  sibling(index - 1, index);
  sibling(index + 1, index);

  function showButton(button, show) {
    if (show) button.enable();
    else button.disable();
  }

  showButton(viewer.previousButton, index - 1 >= 0);
  showButton(viewer.nextButton, index + 1 < viewer.world.getItemCount());
  updateHash();
}

viewer.bindSequenceControls();
viewer.previousButton.removeAllHandlers('release');
viewer.previousButton.addHandler('release', function() {
  show(index - 1);
});
viewer.nextButton.removeAllHandlers('release');
viewer.nextButton.addHandler('release', function() {
  show(index + 1);
});

function updateHash() {
    var tile = viewer.world.getItemAt(index);
    var imp = tile.viewportToImageCoordinates(viewer.viewport.getCenter(true));
    var x = imp.x;
    var y = imp.y;
    var rot = viewer.viewport.getRotation();
    var zoom = tile.viewportToImageZoom(viewer.viewport.getZoom(true));
    window.location.hash = "x=" + x + "&y=" + y + "&zoom=" + zoom + "&rot=" + rot + "&layer=" + layers[index];
}

viewer.addHandler('pan', updateHash);
viewer.addHandler('zoom', updateHash);
viewer.addHandler('rotate', updateHash);

viewer.addHandler('open', function() {
    //console.log("open", origHash);

    var hash = origHash;
    viewer.canvas.focus();

    var params = {}
    hash.split('&').map(hk => {
      let temp = hk.split('=');
        params[temp[0]] = temp[1]
    });

    var tile = viewer.world.getItemAt(index);
    if (params.x) {
        // parse params.x to int
        var x = parseFloat(params.x);
        var y = parseFloat(params.y);
        var imp = new OpenSeadragon.Point(x, y);
        viewer.viewport.panTo(tile.imageToViewportCoordinates(imp), true);
    }
    if (params.zoom) {
        viewer.viewport.zoomTo(tile.imageToViewportZoom(parseFloat(params.zoom)), true);
    }
    if (params.rot) {
        viewer.viewport.setRotation(parseFloat(params.rot), true);
    }
    if (params.layer) {
        var layer = params.layer;
        // find index of element in layers
        var i = layers.indexOf(layer);
        show(i);
    } else
        show(7);
});

viewer.goToPreviousPage = function() {
  show(index - 1);
};
viewer.goToNextPage = function() {
  show(index + 1);
};

viewer.addHandler('full-screen', function(ev) {
  viewer.canvas.focus();
});

viewer.pixelsPerArrowPress = 250;


</script>

<a id="keyboard_shortcuts"></a>
<p>
    You can use the following keys to navigate:
</p>

<ul>
    <li><strong>[ w, up arrow ]</strong> - move viewport <strong>up</strong></li>
    <li><strong>[ s, down arrow ]</strong> - move viewport <strong>down</strong></li>
    <li><strong>[ a, left arrow ]</strong> - move viewport <strong>left</strong></li>
    <li><strong>[ d, right arrow ]</strong> - move viewport <strong>right</strong></li>
    <li><strong>[ 0 ]</strong> - zoom / move viewport <strong>home</strong></li>
    <li><strong>[ - / _, shift+W, shift+up arrow ]</strong> - zoom viewport <strong>out</strong></li>
    <li><strong>[ = / +, shift+S, shift+down arrow ]</strong> - zoom viewport <strong>in</strong></li>
    <li><strong>[ r ]</strong> - rotate <strong>clockwise</strong></li>
    <li><strong>[ R ]</strong> - rotate <strong>counterclockwise</strong></li>
    <li><strong>[ f ]</strong> - flip <strong>horizontally</strong></li>
    <li><strong>[ j ]</strong> - change to <strong>previous</strong> layer</li>
    <li><strong>[ k ]</strong> - change to <strong>next</strong> layer</li>
</ul>